---
title: "Manuscript Figures"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, warning = FALSE, message = FALSE)
# todo: pass this as argument
settings <- yaml::read_yaml('/data/local/buyar/arcas/pancancer_multiomics_manuscript/settings.yaml')
source(settings$utility_script)
library(data.table)
library(ggplot2)
library(pbapply)
library(ggrepel)
library(ggpubr)
library(cowplot)
theme_set(ggpubr::theme_pubclean())

# todo: move this to settings file
inputDir <- '/data/local/buyar/arcas/pancancer_multiomics_manuscript/output'
geneSetScoresFolder <- '/data/local/buyar/arcas/subtyping_paper/data/geneset_scores/singscore'
FigureFolder <- '/data/bimsbstatic/public/akalin/buyar/manuscript_figures_arcas'
assay_dir <- settings$assay_output$folder
surv <- do.call(rbind, readRDS(settings$surv))
projectDict <- sapply(yaml::read_yaml(settings$projectDict), 
                      function(x) gsub(' ', '', unlist(strsplit(x, ','))))
tcga_subtypes <- process_tcga_subtypes()

Figures <- list() # accummulate all figures in this
SuppFigures <- list() # accumulate all supplementary figures in this

TOOLS <- c('pca_factors', 'maui_factors', 'mofa_factors', 'mcia_factors')

fig_count <- 0
supFig_count <- 0
```

```{r import_lfs}
LFs <- sapply(simplify = F, TOOLS, function(folder) {
  message('Importing ',folder)
  files <- dir(file.path(inputDir, folder), pattern = 'factors.csv$', full.names = T)
  LFs <- pbapply::pbsapply(simplify = F, files, function(f) {
    dt <- data.table::fread(f)
    M <- as.matrix(dt[,-1])
    rownames(M) <- dt$V1
    return(M)
  })
  names(LFs) <- unlist(lapply(strsplit(basename(names(LFs)), split = '\\.'), function(x) paste(x[1:2], collapse = '.')))
  return(LFs)
})
```

```{r import_feature_weights}
FWs <- sapply(simplify = F, TOOLS, function(folder) {
  message('Importing ',folder)
  files <- dir(file.path(inputDir, folder), pattern = 'feature_weights.csv$', full.names = T)
  W <- pbapply::pbsapply(simplify = F, files, function(f) {
    dt <- data.table::fread(f)
    M <- as.matrix(dt[,-1])
    rownames(M) <- gsub("^assay: ", "", dt$V1) # required only for maui
    return(M)
  })
  names(W) <- unlist(lapply(strsplit(basename(names(W)), split = '\\.'), 
                            function(x) paste(x[1:2], collapse = '.')))
  return(W)
})
```


```{r}
# Define a function that takes as input LFs and some patient labels (clinical/cancer type/subtype)
# and evaluates predictability of the labels using the LFs
predict_labels <- function(LFs, surv, tcga_subtypes, 
                           project, datatype, label.type, ...) {
  source(settings$utility_script)
  predict_stats <- do.call(rbind, sapply(simplify = F, names(LFs), function(tool) {
    require(data.table)
    message("predicting ",label.type," using ",tool)
    experiment <- paste(project, datatype, sep = '.')
    M <- LFs[[tool]][[experiment]]
    if(label.type == 'cancer_type') {
      labels <- data.frame('cancer_type' = surv[match(rownames(M), bcr_patient_barcode)]$project, 
                           row.names = rownames(M))
    } else if (label.type == 'subtype') {
      labels <- data.frame('subtype' = tcga_subtypes[match(rownames(M),
                                                           bcr_patient_barcode)]$Subtype_Selected, 
                           row.names = rownames(M))
    } else if (label.type == 'clinical') {
      labels <- process_clinical_covariates(rownames(M))
    }
    dt <- do.call(rbind, lapply(colnames(labels), function(x) {
      l <- labels[,x]
      if(is.numeric(l)){
        # categorize samples by intervals
        l <- as.character(cut_interval(l, 10))
      }
      l[is.na(l)] <- 'Undefined'
      message("Predicting ",x, " for experiment ",experiment)
      dt <- suppressMessages(predict_cluster_labels(M, l, ...))
      dt$label.type <- x
      dt$project <- project
      dt$datatypes <- datatype
      dt$method <- tool
      return(dt)
    }))
    return(dt)
  }))
  return(predict_stats[!is.na(train_auc)])
}

plot_comp1 <- function(dt) {
  dt$method <- toupper(gsub("_factors", "", dt$method))
  comps <- lapply(setdiff(unique(dt$method), 'MAUI'), function(x) c('MAUI', x))
  ggboxplot(dt, 
          x = 'method', y = 'test_auc', color = 'method', 
          add = 'jitter', legend = 'none') + 
    stat_compare_means(method = 'wilcox.test', paired = T, 
                       method.args = list('alternative' = 'greater'), 
                     comparisons = comps) +
    labs(y = 'AUC') + theme(axis.text = element_text(size = 10))
}

plot_comp2 <- function(dt) {
  dt$method <- toupper(gsub("_factors", "", dt$method))
  dtc <- melt(dcast(dt, label ~ method, value.var = 'test_auc'), 
              id.vars = c('label', 'MAUI'))
  dtc$difference <- dtc$MAUI - dtc$value
  ggplot(dtc, 
         aes(x = MAUI, y = value)) + 
    geom_point() + geom_abline(slope = 1) + 
    facet_wrap(~ variable, nrow = 1) + 
    labs(y = 'AUC')
} 

get_top_by_label <- function(dt, label.type, topN = 5) {
  do.call(rbind, lapply(split(dt, dt[,get(label.type)]), function(x) {head(x, topN)}))
}

# find percent contribution of different datatypes to the top factor specific variables 
# LFs: Latent factors; nested list
# FWs: Feature weights for each LF; nested list 
# tool: pca/maui/mofa
# project: e.g. pancancer
# datatype: e.g. cnv_gex_mut
# factors: factor vector (e.g. cancer types for each sample or subtype info for each sample)
# top_lfs: top LF to pick per factor
# top_featuers: top features to pick per latent factor
plot_datatype_contribution_by_factor <- function(LFs, FWs, tool, project, datatype, 
                                                 factors, top_lfs = 1, top_features = 100) {
  experiment <- paste0(project, '.', datatype)
  L <- LFs[[tool]][[experiment]]
  W <- FWs[[tool]][[experiment]]
  dt <- get_factor_specific_variables(L, factors)
  top_vars <- get_top_by_label(dt[padj < 0.05][order(padj)], 'ref_cl', topN = top_lfs)
  # for each factor, pick top lfs and pick top features per lf and plot composition
  freq <- do.call(rbind, lapply(split(top_vars, top_vars$ref_cl), function(x) {
    l <- unique(x$variable) # one or more lfs 
    # get top features per lf and concatenate
    f <- do.call(c, lapply(l, function(y) {
      head(sort(abs(W[,y]), decreasing = T), top_features)
    }))
    freq <- data.table(table(sub("^(.+?)\\..+$", "\\1", unique(names(f)))))
    freq$factor <- unique(x$ref_cl)
    colnames(freq)[1] <- 'omics'
    return(freq)
  }))
  
  ggplot(freq, aes(x = factor, y = N)) + 
    geom_bar(stat = 'identity', aes(fill = omics), 
             position = 'fill') + coord_flip() + 
    labs(x = '', y = 'Percentage of top features contributing to top latent factors')
}
```

```{r pancancer_prediction, fig.height=9, fig.width=12}
# Find out if cancer types are predictable using latent factors 
pancancer_stats <- predict_labels(LFs, surv, tcga_subtypes, 'pancancer', 
                                  'cnv_gex_meth_mut', label.type = 'cancer_type', num.trees = 1000)
p1 <- plot_comp1(pancancer_stats) + theme(axis.title.x = element_blank())
p2 <- plot_comp2(pancancer_stats)
# plot cancer specific factors
M <- LFs$maui_factors$pancancer.cnv_gex_meth_mut
ct <- surv[match(rownames(M), bcr_patient_barcode)]$project
p3 <- plot_label_specific_vars(M, ct)

# data type contribution to top LF per factor
p4 <- plot_datatype_contribution_by_factor(LFs, FWs, 'maui_factors', 
                                           'pancancer', 'cnv_gex_meth_mut', factors = ct, 
                                           top_lfs = 1, top_features = 100) 
p4 <- p4 + labs(y = 'Relative Contribution\nto top latent factor') + 
  theme(legend.position = 'right', legend.background = element_blank())


# do unsupervised clustering and compute AMI 
experiment <- 'pancancer.cnv_gex_meth_mut'
df <- do.call(rbind, pbapply::pblapply(TOOLS, function(x) {
  message(x)
  M <- LFs[[x]][[experiment]]
  if(x == 'maui_factors') {
    M <- remove_redundant_variables(M, perc = 99)
  }
  # find cancer types per sample
  ct <- surv[match(rownames(M), bcr_patient_barcode)]$project
  data.frame('tool' = x, 
             'AMI' = compute_AMI(M, k = length(unique(ct)), target_labels = ct))
}))
df$tool <- toupper(gsub("_factors", "", df$tool))
p5 <- ggplot(df, aes(x = tool, y = AMI)) +
  geom_bar(aes(fill = tool), stat = 'identity') + 
  geom_text(aes(label = round(AMI, 2))) + 
  theme(legend.title = element_blank(), axis.title.x = element_blank()) 

Fig <- plot_grid(plot_grid(p1, p2, p5, nrow = 1, labels = c('A', 'B', 'C')), 
                  plot_grid(p3, p4, rel_widths = c(5,3), nrow = 1, labels = c('D', 'E')), 
                  nrow = 2,
                  rel_heights = c(2,3))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.pancancer_cancer_type_prediction.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name), 
              plot = Fig, units = 'in', width = 12, height = 9)

# predictability of subtypes using pancancer LFs
pancancer_subtype_stats <- predict_labels(LFs, surv, tcga_subtypes, 'pancancer', 
                                  'cnv_gex_meth_mut', label.type = 'subtype', num.trees = 1000)

p1 <- plot_comp1(pancancer_subtype_stats) + theme(axis.title.x = element_blank())
p2 <- plot_comp2(pancancer_subtype_stats)
# plot subtype specific factors
M <- LFs$maui_factors$pancancer.cnv_gex_meth_mut
st <- tcga_subtypes[match(rownames(M), bcr_patient_barcode)]$Subtype_Selected
# remove NA values and pick subtypes with at least 20 samples 
selected <- names(which(table(st) > 20))
M <- M[st %in% selected,]
labels <- tcga_subtypes[match(rownames(M), bcr_patient_barcode)]$Subtype_Selected

p3 <- plot_label_specific_vars(M, labels) 

# data type contribution to top LF per factor
p4 <- plot_datatype_contribution_by_factor(LFs, FWs, 'maui_factors', 
                                           'pancancer', 'cnv_gex_meth_mut', factors = st, 
                                           top_lfs = 1, top_features = 100) 
p4 <- p4 + labs(y = 'Relative Contribution\nto top latent factor') + 
  theme(legend.position = 'right', legend.background = element_blank())

Fig <- plot_grid(plot_grid(plot_grid(p1, p2 + theme(axis.text.x = element_text(angle = 45)), 
                                     nrow = 2, labels = c('A', 'B')), 
                           p3 + theme(legend.position = 'none', 
                                      axis.text.x = element_text(angle = 45)), 
                           labels = c('', 'C'), ncol = 2, rel_widths = c(1,3)), 
                 p4 + theme(axis.text.x = element_text(angle = 45)), 
                 labels = c('', '', 'D'), ncol = 2, rel_widths = c(2.5,1))

supFig_count <- supFig_count + 1
ggsave(paste0('SuppFigure', supFig_count, '.pancancer_subtype_prediction.pdf'), 
       plot = Fig, units = 'in', width = 18, height = 12)
SuppFigures[[supFig_count]] <- Fig
```


```{r clustering_metrics, fig.width=10, fig.height=8}
# clustering metrics of various cancers 
# Use top 10 factors (derived from multi-omics) to cluster samples using cancer-specific LFs 

multi_omics_comb <- 'cnv_gex_meth_mut'
experiments <- grep(paste0('^TCGA-.*.', multi_omics_comb), names(LFs$pca_factors), value = T)
cl <- parallel::makeCluster(20)
parallel::clusterExport(cl, varlist = c('LFs', 'experiments', 'settings'))
clusters <- sapply(simplify = F, names(LFs), function(tool) {
  message("Clustering top ",tool)
  pbapply::pbsapply(cl = cl, simplify = F, experiments, function(experiment) {
    message(experiment)
    source(settings$utility_script)
    require(data.table)
    M <- LFs[[tool]][[experiment]]
    if(tool == 'maui_factors') {
      M <- remove_redundant_variables(M, perc = 99) # !!! make sure to use same setting as used for pan-cancer clustering
    } 
    M <- t(subset_features_by_variance(t(M), topN = 10))
    
    val <- c('internal') 
    if(ncol(M) > 2) {val <- c('internal', 'stability')}
    res <- clValid::clValid(obj = M,
                          nClust = 3:8,
                          clMethods = 'kmeans',
                          validation = val,
                          maxitems = 10000,
                          nstart = 1000)
    memberships <- as.data.frame(do.call(cbind, lapply(res@clusterObjs[['kmeans']], function(x) x[['cluster']])))
    colnames(memberships) <- paste0('k', colnames(memberships))
    stats <- as.data.table(res@measures)[V1 %in% c('Silhouette', 'APN')]
    colnames(stats) <- c('metric', 'k', 'clustering_method', 'score')
    return(list('clustering_stats' = stats, 'cluster_memberships' = memberships))
  })
})
parallel::stopCluster(cl)

cluster.stats <- do.call(rbind, lapply(names(clusters), function(tool) {
  do.call(rbind, lapply(names(clusters[[tool]]), function(experiment) {
      cancer_type <- strsplit(experiment, "\\.")[[1]][1]
      datatypes <- strsplit(experiment, "\\.")[[1]][2]
      stats <- clusters[[tool]][[experiment]][['clustering_stats']]
      stats$cancer_type <- cancer_type
      stats$datatypes <- datatypes
      stats$method <- tool
      return(stats)
  }))
}))

# plot silhouette/stability score comparison
dt1 <- cluster.stats[metric == 'Silhouette'][datatypes == multi_omics_comb]
dt1$method <- toupper(gsub("_factors", "", dt1$method))
comps <- lapply(setdiff(unique(dt1$method), 'MAUI'), function(x) c('MAUI', x))

p1 <- ggboxplot(dt1, 
          x = 'method', y = 'score', add = 'jitter', color = 'method') + 
  stat_compare_means(method = 'wilcox.test', paired = TRUE, 
                     comparisons = comps) + 
  labs(title = 'Silhouette score', x = '') + 
  theme(legend.position = 'none')


dt2 <- cluster.stats[metric == 'APN'][datatypes == multi_omics_comb]
dt2$method <- toupper(gsub("_factors", "", dt2$method))
comps <- lapply(setdiff(unique(dt2$method), 'MAUI'), function(x) c('MAUI', x))
p2 <- ggboxplot(dt2, 
          x = 'method', y = 'score', add = 'jitter', color = 'method') + 
  stat_compare_means(method = 'wilcox.test', paired = TRUE, 
                     comparisons = comps) + 
  labs(title = 'Cluster Stability Score (APN)', x = '') + 
  theme(legend.position = 'none')

# combine both scores and plot for different values of k
dt <- dcast(cluster.stats[datatypes == multi_omics_comb], 
            cancer_type + method + k ~ metric, value.var = 'score')
dt$kv <- paste0('kmeans(k=',dt$k,')')
dt$method <- toupper(gsub("_factors", "", dt$method))
p3 <- ggplot(dt,
       aes(x = Silhouette, y = APN)) + 
        geom_point(aes(color = method), size = 3) + 
        facet_wrap(~ kv, ncol = 2) +
        labs(title = 'Multi-omics clustering: Silhouette vs APN')

Fig <- plot_grid(plot_grid(p1, p2, labels = 'AUTO', ncol = 1),
                  p3, ncol = 2, rel_widths = c(2,3), labels = c('','C'))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.cluster_stability_metrics.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name),        
       plot = Fig, units = 'in', 
       width = 10, height = 8)
```


```{r survival_factors, fig.width=12, fig.height=8}
# survival-predictive factors
#I look for survival-predictive maui LFs, show how much c-index improves on top of 
#clinical factors (tumor stage/age/gender) and plot top survival-predictive factor per cancer.

# factors to use in the model
clin_factors <- c('age_at_initial_pathologic_diagnosis', 'gender', 'ajcc_pathologic_tumor_stage')

experiments <- grep('^TCGA-.*.cnv_gex_meth_mut', names(LFs$maui_factors), value = T)
cl <- parallel::makeCluster(20)
parallel::clusterExport(cl, varlist = c('LFs', 'clin_factors', 
                                        'surv', 'experiments', 'settings'))
surv.stats <- pbapply::pbsapply(cl = cl, simplify = F, experiments, function(experiment) {
    require(data.table)
    source(settings$utility_script)
    message(experiment)
    M <- LFs$maui_factors[[experiment]]
    # get clinical factors for the patients in matrix
    clin <- process_clinical_covariates(rownames(M))
    clin <- subset(clin, select = intersect(colnames(clin), clin_factors))
    res <- get_prognostic_covariates(surv, clin, M, 'PFI', 'PFI.time')
    if(!is.null(res)) {
      cancer_type <- strsplit(experiment, "\\.")[[1]][1]
      res$project <- cancer_type
      v <- res[order(pval)][1]$variable
      dat <- merge(clin, M[,v,drop = F], by = 'row.names')
      rownames(dat) <- dat$Row.names
      dat$Row.names <- NULL
      dat <- get_surv_df(surv, dat) # add PFI values
      # compute hazard ratios 
      cox1 <- coxph(Surv(PFI.time,PFI) ~ ., 
              data=dat, x = TRUE)
      hr <- data.frame(summary(cox1)[['conf.int']]) # get hazard ratios with conf intervals
      hr <- hr[grep(v, rownames(hr)), c(1,3,4)]
      colnames(hr) <- c('hr', 'hr_low', 'hr_high')
      rownames(hr) <- v
      p1 <- survminer::ggforest(cox1, data = dat)
      
      # split variable into high/low to compute survival adjusted curves
      cp <- find_survival_cutpoint(dat[,v,drop=F], surv)
      dat[,v] <- ifelse(dat[,v] > cp, paste(v, 'high'), paste(v, 'low'))
      cox2 <- coxph(Surv(PFI.time,PFI) ~ ., 
                    data=dat, x = TRUE)
      p2 <- survminer::ggadjustedcurves(fit = cox2, data = dat, variable = v, method = 'average')
      
      # compute Cindex with all survival-predictive LFs and without LFs 
      vars <- res[pval < 0.05]$variable
      rsf_stats <- fit_RSF_clin(get_surv_df(surv, clin), M[,vars], ntree = 1000)
      
      return(list('stats' = res, 'p1' = p1, 'p2' = p2, 'hr' = hr, 
                  'Cindex_base' = rsf_stats$C_wo, 'Cindex_with_LFs' = rsf_stats$C_with))
    }
    return(NULL)
  })
parallel::stopCluster(cl)

plots <- sapply(simplify = F, names(surv.stats), function(x) {   
  p <- surv.stats[[x]][['p2']] 
  if(!is.null(p)) { 
    p + theme(axis.text.x = element_text(size = 8), 
              axis.text.y = element_text(size = 8), 
              axis.title.x = element_blank(), 
              axis.title.y = element_blank(), 
              legend.title = element_blank(),
              legend.position = c(0.5, 0.9),
              legend.text = element_text(size = 8), 
              legend.background = element_blank(), 
              legend.direction = 'vertical') 
    }
})
plots <- plots[!sapply(plots, is.null)]
p1 <- cowplot::plot_grid(plotlist = plots, nrow = 3, 
                   labels = sapply(strsplit(names(plots), '\\.'), function(x) x[1]), 
                   label_size = 8)
# plot hazard ratios for top LF per cancer type 
hr <- do.call(rbind, lapply(names(surv.stats), function(x) {
  if(is.null(surv.stats[[x]])) {return(NULL)}
  message(x)
  df <- surv.stats[[x]][['hr']]
  df$project <- unlist(strsplit(x, '\\.'))[[1]]
  return(df)
}))
hr$latent_factor <- rownames(hr)
# remove hr with Inf values
hr <- hr[!is.infinite(hr$hr_high),]

p2 <- ggplot(hr, aes(x = reorder(paste0(project, ' (', latent_factor, ')'), hr), y = log(hr))) +
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = log(hr_low), ymax = log(hr_high)), width = 0.2) + 
  labs(x = '', y = 'log(hazard-ratio) of top latent factor per cancer\n(adjusted for tumor stage + age + gender)')+
  coord_flip()

# make a plot to show improvement in C index with LFs on top of clinical factors
ci <- do.call(rbind, lapply(names(surv.stats), function(x) {
  if(is.null(surv.stats[[x]])) {return(NULL)}
  df <- data.frame('base' = surv.stats[[x]][['Cindex_base']], 
                   'with_lf' = surv.stats[[x]][['Cindex_with_LFs']], 
                   'project' = unlist(strsplit(x, '\\.'))[[1]])
  return(df)
}))

dt <- melt(ci, id.vars = 'project')
dt$variable <- ifelse(dt$variable == 'base', 'Only clinical factors', 'Clinical factors + MAUI LFs')

p3 <- ggplot(ci, aes(x = reorder(project, with_lf))) + 
  geom_segment(aes(x = reorder(project, with_lf), xend = project, 
                   y = base, yend = with_lf)) + 
  geom_point(data = dt, aes(x = project, y = value, color = variable), size = 6) +
  coord_flip() + 
  labs(x = '', y = '') + 
  theme(legend.title = element_blank(), legend.position = 'bottom', 
        legend.background = element_blank(), 
        legend.margin = margin(), 
        legend.direction = 'vertical', legend.box.background = element_blank()) +
  scale_color_brewer(type = 'qual', palette = 6)

Fig <- cowplot::plot_grid(cowplot::plot_grid(p3, p2, nrow = 1, labels = c('A', 'B')),
                        p1, labels = c('', 'C'), nrow = 2)

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.surv.Cindex_improv.hazard_ratio.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, width = 12, height = 14, units = 'in')
```


```{r clinical_factors, fig.width=12, fig.height=9}
# clinical factor associated MAUI LFs
# Find maui LFs associated to clinical factors and plot them

experiments <- grep('^TCGA-.*.cnv_gex_meth_mut', names(LFs$maui_factors), value = T)
# find clinical-factor associated LFs 
cl <- parallel::makeCluster(10)
parallel::clusterExport(cl, varlist = c('experiments', 'LFs', 'settings'))
clin.stats <- do.call(rbind, 
        pbapply::pbsapply(cl = cl, simplify = F, 
               experiments, function(experiment) {
               require(data.table)
               source(settings$utility_script)
               M <- LFs$maui_factors[[experiment]]
               clin <- process_clinical_covariates(rownames(M))
               dt <- do.call(rbind, 
                    pbapply::pbsapply(simplify = F, 
                                      colnames(clin), function(x) {
                      if(!is.numeric(clin[,x])) {
                        factors <- clin[,x]
                        m <- M[!is.na(factors),]
                        factors <- factors[!is.na(factors)]
                        dt <- get_factor_specific_variables(m, factors) 
                        dt$label <- x
                        return(dt)
                      }
                      return(NULL)
                      }))
               dt$project <- unlist(strsplit(experiment, "\\."))[[1]]
               return(dt)
             }))
parallel::stopCluster(cl)

# find top factors per project per label and plot
dt <- clin.stats[padj < 0.05, .SD[which.min(padj)],by = c('project', 'label')]

require(ggrepel)
dt$label <- stringr::str_wrap(gsub('_', ' ', dt$label), width = 8)
p1 <- ggplot(dt, aes(x = project, y = label)) + 
  geom_point(aes(color = -log10(padj), size = -log10(padj))) + 
  geom_text_repel(aes(label = variable)) + 
  coord_flip() +
  scale_color_gradient(low = 'blue', high = 'red') + 
  labs(x = '', y = 'clinical factor')

# pick example cases and show more detailed LF activation 
# top examples by clinical factor type
# top 5 variables per clinical factor 
top <- clin.stats[padj < 0.05,.SD[which.min(padj)], by = label][order(padj),.SD[which.min(padj)],by = project]
plots <- sapply(simplify = FALSE, 1:4, function(i) {
  pr <- top$project[i]
  l <- top$label[i]
  M <- LFs$maui_factors[[paste0(pr, '.cnv_gex_meth_mut')]]
  factors <- process_clinical_covariates(rownames(M))[[l]]
  M <- M[!is.na(factors),]
  factors <- factors[!is.na(factors)]
  plot_label_specific_vars(M, factors, string_width = 24)+ 
    labs(title = pr, subtitle = l) + 
    theme(legend.position = 'none')
})

p2 <- cowplot::plot_grid(plotlist = plots[1:2], nrow = 2, labels = c('B', 'C'))

Fig <- cowplot::plot_grid(p1, p2, rel_widths = c(3,2), labels = c('A'))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.clinical_factors.LFs.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, units = 'in', width = 12, height = 9)
```

```{r msi_stats, fig.width=10, fig.height=8}
# Predicting MSI status using latent factors
# predict MSI status for pan-gastrointestinal tumors
# read MSI data
dataDir <- settings$GDCdataDir
MSI <- do.call(rbind, lapply(projectDict$`pan-gastrointestinal`, function(pr) {
  f <- file.path(dataDir, paste0(pr, '.MSI.tsv'))
  dt <- data.table::fread(f)[,c(2,4)]
  colnames(dt)[2] <- 'MSI'
  dt$project <- pr
  return(dt)
}))
# remove samples with undertermined MSI status
MSI <- MSI[MSI %in% c('MSI-H', 'MSI-L', 'MSS')]
msi_stats <- do.call(rbind, lapply(names(LFs), function(tool) {
  message(tool)
  M <- LFs[[tool]][['pan-gastrointestinal.cnv_gex_meth_mut']]
  y <- MSI[match(rownames(M), bcr_patient_barcode)]$MSI
  M <- M[!is.na(y),]
  y <- y[!is.na(y)]
  #res <- predict_cluster_labels(M, y, partition = 0.6, num.trees = 2000)
  res <- predict_cluster_labels_glmnet(M, y)
  #res <- predict_labels_glmnet(M, y)
  res$method <- tool
  return(res)
}))
msi_stats$method <- toupper(gsub('_factors', '', msi_stats$method))

p1 <- ggplot(msi_stats[method == 'MAUI'], aes(x = label, y = auc)) +
  geom_bar(stat = 'identity', aes(fill = label)) + 
  labs(y = 'AUC', x = '') +
  geom_errorbar(aes(ymin = auc.lower, ymax = auc.upper), width = 0.2)+
  theme(legend.title = element_blank())

# make some maui specific plots to explore MSI related LFs
M <- remove_redundant_variables(LFs$maui_factors[['pan-gastrointestinal.cnv_gex_meth_mut']], 
                                perc = 99) # make it consistent with pan-cancer
y <- MSI[match(rownames(M), bcr_patient_barcode)]$MSI 
M <- M[!is.na(y),]
y <- y[!is.na(y)]

# tsne plot of top LF related to MSI-H and MSI classes
dt <- get_factor_specific_variables(M, y)
# use top predictive lfs to guide tsne 
top_vars <- unique(get_top_by_label(dt[padj < 0.05][order(padj)], 'ref_cl', 5)[['variable']])

df <- plot_tsne(M[,top_vars], y, returnData = T)
# color tsne by top lf informative for MSI-H
top_lf <- dt[order(padj)][ref_cl == 'MSI-H']$variable[1]
df <- merge(df, data.frame(M[,top_lf,drop =F]), by = 'row.names')
df$cancertype <- surv[match(df$Row.names, bcr_patient_barcode)]$project
df$subtype <- tcga_subtypes[match(df$Row.names, bcr_patient_barcode)]$Subtype_Selected

p2.1 <- ggplot(df, aes(x = tSNE1, y = tSNE2)) + geom_point(aes(color = as.factor(group))) + 
  theme(legend.title = element_blank())
p2.2 <- ggplot(df, aes(x = tSNE1, y = tSNE2)) + 
  geom_point(aes_string(color = top_lf)) + 
  scale_color_gradient(low = 'gray', high = 'red')

# top features that contribute to top factors relevant to MSI status prediction
f <- data.table::fread(file.path(inputDir, 'maui_factors', 
                               paste('pan-gastrointestinal', # project 
                                      'cnv_gex_meth_mut', #data type
                                      'maui_factors', # tool
                                      'feature_weights.csv', sep = '.')))
feat.M <- as.matrix(f[,-1])
rownames(feat.M) <- gsub('assay: ', '', f$V1)

# sort features by contribution to LF and plot by data type 
df <- data.frame(feat.M[,top_lf,drop = F])
df$data.type <- sub('^(.+?)\\..+$', '\\1', rownames(df))

# get top 100 features
df <- df[order(abs(df[,top_lf]), decreasing = T),]
freq <- do.call(rbind, lapply(0:29, function(i) {
  s <- (i*100+1)
  e <- (i+1)*100
  x <- data.frame(table(df[s:e,]$data.type))
  x$rank <- stringr::str_wrap(paste0("[",s,",",e,"]"),
                              width = 8)
  x$ind <- i
  return(x)
}))
p3 <- ggplot(freq[freq$ind < 5,], aes(x = reorder(rank, ind), y = Freq)) + 
  geom_bar(aes(fill = Var1), stat='identity') + 
  theme(legend.title = element_blank(), axis.text.x = element_text(angle = 45)) + 
  labs(x = paste0("top features contributing to ",top_lf)) 
  

Fig <- cowplot::plot_grid(p1, 
                          plot_grid(p2.1, p2.2, p3, nrow = 1, labels = c('B', 'C', 'D')),
                          nrow = 2, labels = c('A', ''), rel_heights = c(5,3))
fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.MSI.status.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, units = 'in', width = 10, height = 8)
```


```{r semi_supervised_subtypes, fig.width=10, fig.height=12}
# Semi-supervised clustering of samples 
# 1. Cluster samples by LFs associated to known TCGA subtypes or those that are associated to survival outcomes. 
#2. Annotate each cluster using cancer state scores or hallmark gene set scores 

## TCGA subtype informed clusters 
## Use-case: pan-gastrointestinal cancers
require(survminer)
require(cluster)
pr <- 'pan-gastrointestinal' 
experiment <- paste0(pr, '.cnv_gex_meth_mut')
M <- LFs$maui_factors[[experiment]]
st <- tcga_subtypes[match(rownames(M), bcr_patient_barcode)]$Subtype_Selected
# find subtype specific LFs 
dt <- get_factor_specific_variables(M, st)

vars <- unique(get_top_by_label(dt[padj < 0.05][order(padj)], 'ref_cl', 3)[['variable']])

k <- length(na.omit(unique(st))) # set k to number of known subtypes
# cluster samples using only subtype specific factors 
clust <- data.frame(get_kmeans_subtypes(M[,vars], k_vals = k, min_cluster_size = 0))

# plots
df <- plot_tsne(M[,vars], as.factor(clust[,1]), returnData = T)
colnames(df)[3] <- 'maui'
df$tcga <- tcga_subtypes[match(rownames(df), bcr_patient_barcode)]$Subtype_Selected
df$cancertype <- surv[match(rownames(df), bcr_patient_barcode)]$project

p <- ggplot(df, aes(x = tSNE1, y = tSNE2))  
p1 <- p + geom_point(aes(color = maui)) +
  geom_text_repel(data = get_centroid(df[,1:2], df$maui), 
            aes(x,y,label = text.label), size = 6)
p2 <- p + geom_point(aes(color = tcga)) + 
        geom_text_repel(data = get_centroid(df[,1:2], df$tcga), 
            aes(x,y,label = text.label), size = 5)
p3 <- plot_survival(surv, df[,'maui',drop =F])[['plot']] + theme(legend.position = 'none') + labs(y = 'Progression Free Survival')
p4 <- plot_survival(surv, df[,'tcga',drop =F])[['plot']] + theme(legend.position = 'none') + labs(y = 'Progression Free Survival')

# use hallmark gene sets to annotate cluster specific functions
scores <- import_geneset_scores(geneSetScoresFolder, 'msigdb_hallmarks')

S <- scores[intersect(rownames(M), rownames(scores)),]
colnames(S) <- gsub("HALLMARK_", "", colnames(S))
clust$tcga <- tcga_subtypes[match(rownames(clust), bcr_patient_barcode)]$Subtype_Selected

# plot top gene sets
h1 <- plot_label_specific_vars(S, clust[rownames(S), 1], 
                              as_heatmap = T, cellwidth = 10, 
                              cellheight = 12,
                              top_vars_per_label = 2)
h2 <- plot_label_specific_vars(S, clust[rownames(S), 2], 
                              as_heatmap = T, cellwidth = 10, 
                              cellheight = 12, 
                              top_vars_per_label = 2)

# altogether
Fig <-  cowplot::plot_grid(p1, p2, p3, p4, h1$gtable, h2$gtable, 
                         labels = 'AUTO', ncol = 2)

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.semi_supervised.clustering.', experiment,'.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       Fig, units = 'in', 
       width = 10, height = 12)
```

```{r semi_supervised_survival, fig.width=10, fig.height=12}

## Clustering informed by survival outcomes
## Pick survival-predictive LFs and cluster samples based on those

# factors to use in the model
clin_factors <- c('age_at_initial_pathologic_diagnosis', 'gender', 'ajcc_pathologic_tumor_stage')

experiments <- grep('^TCGA-.*.cnv_gex_meth_mut', names(LFs$maui_factors), value = T)
cl <- parallel::makeCluster(20)
parallel::clusterExport(cl, varlist = c('LFs', 'clin_factors', 'surv', 
                                        'experiments', 'settings'))
prog.clust <- pbapply::pbsapply(cl = cl, simplify = F, experiments, 
                                function(experiment){
    require(data.table)
    require(survminer)
    source(settings$utility_script)
    message(experiment)
    M <- LFs$maui_factors[[experiment]]
    # get clinical factors for the patients in matrix
    clin <- process_clinical_covariates(rownames(M))
    clin <- subset(clin, select = intersect(colnames(clin), clin_factors))
    res <- get_prognostic_covariates(surv, clin, M, 'PFI', 'PFI.time')
    # now cluster samples based on only survival predictive factors
    prog_lfs <- unique(res$variable)
    if(length(prog_lfs) < 2) {
      return(NULL)
    }
    clust <-  get_kmeans_subtypes(M[,prog_lfs], k_vals = 3:8, min_cluster_size = 0)
    # find value of k which minimizes log-rank p-value
    dt <- do.call(rbind, lapply(colnames(clust), function(x) {
      message(x)
      pval <- plot_survival(surv, clust[,x,drop=F], return_pval = T)
      data.table('k' = x, 'pval' = pval)
    }))
    
    # return clustering with best result
    top <- dt[order(pval)][1]$k
    return(list('prog.lf' = M[,prog_lfs], 'prog.clust' = clust[,top,drop = F]))
})
parallel::stopCluster(cl)

# compare maui prognostic clusters with TCGA labels 
stats <- do.call(rbind, lapply(names(prog.clust), function(experiment) {
  message(experiment)
  if(is.null(prog.clust[[experiment]])) {return(NULL)}
  df <- data.frame(prog.clust[[experiment]][['prog.clust']])
  colnames(df)[1] <- 'maui'
  df$tcga <- tcga_subtypes[match(rownames(df), bcr_patient_barcode)]$Subtype_Selected
  do.call(rbind, lapply(colnames(df), function(x) {
    if(length(unique(df[,x])) < 2) {
      pval <- NA
    } else {
      pval <- plot_survival(surv, df[,x,drop = F], return_pval = T)
    }
    return(data.table('source' = x, 'pval' = pval, 'experiment' = experiment))
  }))
}))

stats$cancertype <- gsub('.cnv_gex_meth_mut', '', stats$experiment)
# which cancers can we improve upon tcga?
p1 <- ggplot(stats, aes(x = cancertype, y = -log10(pval))) +  
  geom_bar(stat = 'identity', aes(fill = source), position = 'dodge') +
  geom_hline(yintercept = -log10(0.05)) + 
  coord_flip() + 
  scale_fill_brewer(type = 'qual', palette = 6) 

# use canonical pathways to annotate prognostic groups
scores <- import_geneset_scores(geneSetScoresFolder, 'msigdb_canonical_pathways')

# scores: geneset scores
# M: survival predictive LF matrix
# maui_clust: best survival prognostic clustering of M 
plot_clusts <- function(M, maui_clust, scores) {
  df <- plot_tsne(M, as.factor(maui_clust[,1]), returnData = T)
  colnames(df)[3] <- 'maui'

  p1 <- ggplot(df, aes(x = tSNE1, y = tSNE2)) + 
    geom_point(aes(color = maui)) +
    geom_text_repel(data = get_centroid(df[,1:2], df$maui), 
            aes(x,y,label = text.label), size = 6)
  # plot survival for the worst prognostic group, and the rest
  ms <- get_median_survival_by_group(surv, df[,'maui',drop=F])

  # find clusters with worst/best prognosis (by median survival)
  worst <- names(sort(ms)[1])
  best <- names(sort(ms, T)[1])
  
  p2 <- plot_survival(surv, 
                      df[df$maui %in% c(best, worst), 
                         'maui', drop = F])[['plot']] +
    labs(y = 'PFI') +
    theme(legend.position = 'left', legend.title = element_blank()) + 
    scale_color_brewer(type = 'qual', palette = 6)
  
  # heatmap of hallmark scores for best/worst survivors
  selected <- intersect(rownames(df[df$maui %in% c(worst, best),]), rownames(S))
  dt <- get_factor_specific_variables(S[selected,], df[selected, 'maui'])
  # select factors 
  dt[padj < 0.05][order(padj)]
  h1 <- plot_label_specific_vars(S[selected,], 
                                 df[selected, 'maui'], 
                                 padj_threshold = 0.1,
                                as_heatmap = T, cellwidth = 15, 
                                top_vars_per_label = 5, cellheight = 15)
  return(list('p1' = p1, 'p2' = p2, 'h1' = h1))
}

# plot examples for which we improve upon tcga
dt <- data.table(dcast(stats, experiment ~ source, value.var = 'pval'))
dt$improvement <- -log10(dt$maui) - -log10(dt$tcga)
dt <- dt[order(improvement, decreasing = T)]

e <- dt[1,]$experiment
M <- prog.clust[[e]]$prog.lf
maui_clust <- prog.clust[[e]]$prog.clust
S <- scores[intersect(rownames(M), rownames(scores)),]
P <- plot_clusts(M, maui_clust, S)

Fig <- cowplot::plot_grid(p1, plot_grid(P$p1, P$p2, nrow = 1, labels = c('B', 'C')), 
                   P$h1$gtable, nrow = 3, labels = c('A', '', 'D'))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.semi_supervised.prognostic.clustering.', experiment,'.pdf')
names(Figures[fig.count]) <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, units = 'in', 
       width = 10, height = 12)

```

```{r print_figures, results='asis', include=TRUE, fig.width=10, fig.height=11}
base_url <- 'https://bimsbstatic.mdc-berlin.de'
for(i in 1:length(Figures)) {
  fig.url <- gsub("/data/bimsbstatic/public", base_url, file.path(FigureFolder, names(Figures)[i]))
  cat("# Figure",i)
  print(Figures[[i]])
  cat("High-res image:",fig.url,"\n\n")
}
```


