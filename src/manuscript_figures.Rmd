---
title: "Manuscript Figures"
output:
  word_document: default
  html_document: default
params:
  settings_file: ''
  figures_folder: '/data/bimsbstatic/public/akalin/buyar/manuscript_figures_arcas/test'
  workdir: '.'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8.27, fig.height = 11.69)
knitr::opts_knit$set(root.dir = params$workdir)
settings <- yaml::read_yaml(params$settings_file)
message(settings$GDCdataDir)
FigureFolder <- params$figures_folder
source(settings$utility_script)
library(data.table)
library(ggplot2)
library(pbapply)
library(ggrepel)
library(ggpubr)
library(cowplot)
library(ggridges)
library(ggcorrplot)
library(ComplexHeatmap)
library(pheatmap)
library(survminer)
library(survival)
library(caret)
library(treeheatr)
library(partykit)

theme_set(ggpubr::theme_pubclean())
geneSetScoresFolder <- '/data/local/buyar/arcas/subtyping_paper/data/geneset_scores/singscore'

inputDir <- settings$pipeline_output
assay_dir <- settings$assay_output$folder
surv <- do.call(rbind, readRDS(settings$surv))
projectDict <- sapply(yaml::read_yaml(settings$projectDict), 
                      function(x) gsub(' ', '', unlist(strsplit(x, ','))))
tcga_subtypes <- process_tcga_subtypes()

ens2hgnc <- readRDS(settings$ens2hgnc)
cpg2hgnc <- readRDS(settings$cpg2hgnc)

TOOLS <- c('maui_factors', 'mofa_factors', 'mcia_factors', 'pca_factors')

Figures <- list() # accummulate all figures in this
SuppFigures <- list() # accumulate all supplementary figures in this
Legends <- list() # figure legend text
SuppLegends <- list() # supplementary figure legend text

fig_count <- 0
supFig_count <- 0
```

```{r import_lfs}
LFs <- import_LFs(TOOLS, inputDir)
```

```{r import_feature_weights}
FWs <- import_feature_weights(TOOLS, inputDir)
```


```{r}
get_top_by_label <- function(dt, label.type, topN = 5) {
  do.call(rbind, lapply(split(dt, dt[,get(label.type)]), function(x) {head(x, topN)}))
}

map_ids <- function(markers, cpg2hgnc, ens2hgnc) {
  dt <- data.table::data.table('id' = gsub("^.+?\\.", "", markers), 
                               'type' = sub("(^.+?)\\..+$", "\\1", markers), 
                               'variable' = markers)
  do.call(rbind, lapply(names(split(dt, dt$type)), function(x) {
    message(x)
    if(x == 'meth') {
      dt.map <- cpg2hgnc[cpg_site %in% dt[type == x]$id]
      colnames(dt.map) <- c('id', 'hgnc')
      return(merge(dt[type == x], dt.map,  by = 'id'))
    } else if (x == 'cnv') {
      dt.map <- dt[type == x]
      dt.map$hgnc <- gsub("^.+?\\.", "", dt.map$variable)
      return(dt.map)
    } else if (x == 'gex' || x == 'mut') {
      dt.map <- ens2hgnc[ref_gene_id %in% dt[type == x]$id]
      colnames(dt.map) <- c('id', 'hgnc')
      return(merge(dt[type == x], dt.map,  by = 'id'))
    }
  }))
}
```

```{r pancancer_prediction}
# In this section, we make figures about pan-cancer classification 
# and some benchmarks of cohort-based unsupervised clustering across cancers

# 1. pancancer classification
# Find out if cancer types are predictable using latent factors 
res <- sapply(simplify = F, names(LFs), function(tool) {
  message(date(), " => ", tool)
  M <- LFs[[tool]]$pancancer.cnv_gex_meth_mut
  ct <- gsub("-", "_", surv[match(rownames(M), bcr_patient_barcode)]$project)
  res <- predict_labels_glmnet_multiclass(M, ct, partition = 0.6, nodes = 20)
})

pancancer_stats <- sapply(res, function(x) {
  caret::multiClassSummary(x, lev = levels(x$obs))
})

dt <- data.table(melt(pancancer_stats))[Var1 %in% c('Mean_Balanced_Accuracy')]
dt$Var2 <- toupper(gsub("_factors", "", dt$Var2))
p1 <- ggplot(dt, aes(x = Var2, y = value)) + 
  geom_bar(stat = 'identity', aes(fill = Var2)) + 
  labs(y = 'Mean Balanced Accuracy') + 
  theme(legend.position = 'none', axis.title.x = element_blank(), 
        axis.text = element_text(size = 14), axis.title = element_text(size = 16)) + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.1))

# performance visualisation - misclassified examples 
m <- as.matrix(table(res$maui_factors$pred, res$maui_factors$obs))
p2 <- pheatmap::pheatmap(apply(m, 1, function(x) round(x/sum(x) * 100, 1)), cluster_rows = F, cluster_cols = F, 
          silent = T, cellwidth = 10, cellheight = 10)

# plot cancer specific factors
M <- LFs$maui_factors$pancancer.cnv_gex_meth_mut
ct <- surv[match(rownames(M), bcr_patient_barcode)]$project

p3 <- plot_tsne(M, ct, show.labels = T) + 
  theme(legend.position = 'none')

p4 <- plot_label_specific_vars(M, ct)

# data type contribution to top LF per factor
p5 <- plot_datatype_contribution_by_factor(LFs, FWs, 'maui_factors', 
                                           'pancancer', 'cnv_gex_meth_mut', factors = ct, 
                                           top_lfs = 1, top_features = 100) 
p5 <- p5 + labs(y = 'Relative Contribution\nto top latent factor') + 
  theme(legend.position = 'top', legend.background = element_blank(), 
        legend.title = element_blank())


# 2. Cohort-based unsupservised clustering benchmark
# clustering metrics of various cancers 
# Use top most-variable factors (derived from multi-omics) to cluster samples using cancer-specific LFs 
multi_omics_comb <- 'cnv_gex_meth_mut'
experiments <- grep(paste0('^TCGA-.*.', multi_omics_comb), names(LFs$pca_factors), value = T)
cl <- parallel::makeCluster(20)
parallel::clusterExport(cl, varlist = c('LFs', 'experiments', 'settings'))
cluster.stats <- do.call(rbind, sapply(simplify = F, names(LFs), function(tool) {
  message("Clustering top ",tool)
  stats <- do.call(rbind, pbapply::pbsapply(cl = cl, simplify = F, 
                                            intersect(names(LFs[[tool]]), experiments), 
                    function(experiment) {
    message(experiment)
    source(settings$utility_script)
    library(data.table)
    M <- LFs[[tool]][[experiment]]
    if(tool == 'maui_factors') {
      # to avoid highly correlated maui LFs to dominate clusters
      M <- scale(t(remove_redundant_variables(t(M))))
    } 
    # use top 5 most-variable factors for clustering
    M.sub <- t(subset_features_by_variance(t(M), topN = 5))
    val <- c('internal') 
    if(ncol(M.sub) > 2) {val <- c('internal', 'stability')}
    cl_res <- clValid::clValid(obj = M.sub,
                          nClust = 3:8,
                          clMethods = 'kmeans',
                          validation = val,
                          maxitems = 10000,
                          nstart = 1000, iter.max = 30)
    stats <- data.table::as.data.table(cl_res@measures)[V1 %in% c('Silhouette', 'APN')]
    colnames(stats) <- c('metric', 'k', 'clustering_method', 'score')
    stats$cancer_type <- strsplit(experiment, "\\.")[[1]][1]
    stats$datatypes <- strsplit(experiment, "\\.")[[1]][2]
    return(stats)
  }))
  stats$method <- tool
  return(stats)
}))
parallel::stopCluster(cl)

# plot silhouette/stability score comparison
dt1 <- cluster.stats[metric == 'Silhouette'][datatypes == multi_omics_comb,
                                             .SD[which.max(score)],
                                             by = c('cancer_type', 'method', 'k')]
dt1$method <- toupper(gsub("_factors", "", dt1$method))
comps <- lapply(setdiff(unique(dt1$method), 'MAUI'), function(x) c('MAUI', x))

p6 <- ggboxplot(dt1, 
          x = 'method', y = 'score', add = 'jitter', color = 'method') + 
  stat_compare_means(method = 'wilcox.test', paired = TRUE, 
                     comparisons = comps) + 
  labs(title = 'Silhouette score', x = '') + 
  theme(legend.position = 'none')


dt2 <- cluster.stats[metric == 'APN'][datatypes == multi_omics_comb,
                                             .SD[which.min(score)],
                                             by = c('cancer_type', 'method', 'k')]
dt2$method <- toupper(gsub("_factors", "", dt2$method))
comps <- lapply(setdiff(unique(dt2$method), 'MAUI'), function(x) c('MAUI', x))
p7 <- ggboxplot(dt2, 
          x = 'method', y = 'score', add = 'jitter', color = 'method') + 
  stat_compare_means(method = 'wilcox.test', paired = TRUE,  
                     comparisons = comps) + 
  labs(title = 'Cluster Stability Score (APN)', x = '') + 
  theme(legend.position = 'none')

# combine plots for main figure 
Fig <- plot_grid(plot_grid(p3, p5, nrow = 1, labels = c('A', 'B'),
                           rel_widths = c(2,1)), 
                  plot_grid(p6, p7, nrow = 1, labels = c('C', 'D')), 
                  nrow = 2,
                  rel_heights = c(2,1))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.benchmarks.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name),
              plot = Fig, units = 'in', width = 12, height = 12)
Legends[[fig_count]] <- " A) tSNE plot of MAUI latent factors learned from pan-cancer dataset  B) Percentage of top feature types contributing to top predictive maui latent factor per cancer type. C, D) Comparison of unsupervised clustering performances based on cluster homogeneity (Silhouette) in C and cluster stability (Average Proportion of Non-Overlap (APN) in D. Each point represents a clustering score for 132 k-means clustering results (21 cancer types x for 6 different values of k from 3 to 8) for each tool."

# supplementary figure

supFig <- cowplot::plot_grid(cowplot::plot_grid(p1, p2$gtable, nrow = 1, 
                                                labels = c('A', 'B'), rel_widths = c(1.2, 2)), 
                          p4, nrow = 2, labels = c('', 'C'), rel_heights = c(1.2, 2))
# print p3 to supplements 
supFig_count <- supFig_count + 1
SuppFigures[[supFig_count]] <- supFig
fig.name <- paste0('SuppFigure', supFig_count, '.benchmarks.supp.pdf')
names(SuppFigures)[supFig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name), 
              plot = supFig, units = 'in', width = 8.27, height = 11.69)
SuppLegends[[supFig_count]] <- "A) Predictive power of latent factors in distinguishing cancer types comparing MAUI with PCA/MOFA/MCIA. Mean Balanced Accuracy computed on the test dataset (30% of held-out data) trained on 70% of the dataset using an Elastic Net multi-class model. B) Confusion matrix of predicted versus true labels of samples' cancer types. The color of each cell represents the percentage of samples from the cancer type in the rows that are classified into the cancer types on the column. Cells that deviate from the red color represent relatively lower
level of classification accuracy. C) Top maui LFs detected per cancer type. Size/color/opacity of the points represent the average neural activation value of the LF for the corresponding cancer type samples."
```


```{r clinical_survival_factors}
# here we compute LFs associated to clinical factors (e.g. tumor stage, gender etc) and 
# survival outcomes (PFI)

## 1. clinical factor associated MAUI LFs
# Find maui LFs associated to clinical factors and plot them

experiments <- grep('^TCGA-.*.cnv_gex_meth_mut', names(LFs$maui_factors), value = T)
# find clinical-factor associated LFs 
cl <- parallel::makeCluster(10)
parallel::clusterExport(cl, varlist = c('experiments', 'LFs', 'settings'))
clin.stats <- do.call(rbind, 
        pbapply::pbsapply(cl = cl, simplify = F, 
               experiments, function(experiment) {
               require(data.table)
               source(settings$utility_script)
               M <- LFs$maui_factors[[experiment]]
               clin <- process_clinical_covariates(rownames(M))
               dt <- do.call(rbind, 
                    pbapply::pbsapply(simplify = F, 
                                      colnames(clin), function(x) {
                      if(!is.numeric(clin[,x])) {
                        factors <- clin[,x]
                        m <- M[!is.na(factors),]
                        factors <- factors[!is.na(factors)]
                        dt <- get_factor_specific_variables(m, factors) 
                        dt$label <- x
                        return(dt)
                      }
                      return(NULL)
                      }))
               dt$project <- unlist(strsplit(experiment, "\\."))[[1]]
               return(dt)
             }))
parallel::stopCluster(cl)

# find top factors per project per label and plot
dt <- clin.stats[padj < 0.05, .SD[which.min(padj)],by = c('project', 'label')]

require(ggrepel)
dt$label <- stringr::str_wrap(gsub('_', ' ', dt$label), width = 8)
p1 <- ggplot(dt, aes(x = project, y = label)) + 
  geom_point(aes(color = -log10(padj), size = -log10(padj))) + 
  geom_text_repel(aes(label = variable)) + 
  coord_flip() +
  scale_color_gradient(low = 'blue', high = 'red') + 
  labs(x = '', y = 'clinical factor')

# 2. survival-predictive factors
#I look for survival-predictive maui LFs, show how much c-index improves on top of 
#clinical factors (tumor stage/age/gender) and plot top survival-predictive factor per cancer.

# factors to use in the model
clin_factors <- c('age_at_initial_pathologic_diagnosis', 'gender', 'ajcc_pathologic_tumor_stage')
event <- 'PFI'
time <- 'PFI.time'

experiments <- grep('^TCGA-.*.cnv_gex_meth_mut', names(LFs$maui_factors), value = T)
cl <- parallel::makeCluster(10)
parallel::clusterExport(cl, varlist = c('LFs', 'clin_factors', 'event', 'time',
                                        'surv', 'experiments', 'settings'))
surv.stats <- pbapply::pbsapply(cl = cl, simplify = F, experiments, function(experiment) { 
  require(data.table)
  require(survminer)
  require(survival)
  source(settings$utility_script)
  message(experiment)
  M <- LFs$maui_factors[[experiment]]
  # get clinical factors for the patients in matrix
  clin <- process_clinical_covariates(rownames(M))
  clin <- subset(clin, select = intersect(colnames(clin), clin_factors))
  # first filter variables by importance 
  fit <- fit_RSF(surv, M, 500, time, event)
  vars <- names(head(sort(fit$importance, decreasing = T), 5))
    
  # compute adjusted survival curve for thb top factor
  v <- vars[1] 
  dat <- merge(clin, M[,v,drop = F], by = 'row.names')
  rownames(dat) <- dat$Row.names
  dat$Row.names <- NULL
  dat <- get_surv_df(surv, dat, event, time)

  # split variable into high/low to compute survival adjusted curves
  cp <- find_survival_cutpoint(dat[,v,drop=F], surv, event_col = event, duration_col = time)
  dat[,v] <- ifelse(dat[,v] > cp, paste(v, '>', round(cp, 1)), paste(v, '<=', round(cp, 1)))
  cox2 <- coxph(Surv(time,status) ~ ., 
                data=dat, x = TRUE)
  p <- survminer::ggadjustedcurves(fit = cox2, data = dat, variable = v, method = 'average')
  
  # compute Cindex with all survival-predictive LFs and without LFs 
  rsf_stats <- fit_RSF_clin(get_surv_df(surv, clin, event, time), 
                            M[,vars], ntree = 1000)
  
  return(list('p' = p, 
              'Cindex_base' = rsf_stats$C_wo, 
              'Cindex_with_LFs' = rsf_stats$C_with))
})
parallel::stopCluster(cl)


# make a plot to show improvement in C index with LFs on top of clinical factors
ci <- do.call(rbind, lapply(names(surv.stats), function(x) {
  if(is.null(surv.stats[[x]])) {return(NULL)}
  df <- data.frame('base' = surv.stats[[x]][['Cindex_base']], 
                   'with_lf' = surv.stats[[x]][['Cindex_with_LFs']], 
                   'project' = unlist(strsplit(x, '\\.'))[[1]])
  return(df)
}))

dt <- melt(ci, id.vars = 'project')
dt$variable <- ifelse(dt$variable == 'base', 'Only clinical factors', 'Clinical factors + MAUI LFs')

p2 <- ggplot(ci, aes(x = reorder(project, with_lf))) + 
  geom_segment(aes(x = reorder(project, with_lf), xend = project, 
                   y = base, yend = with_lf)) + 
  geom_point(data = dt, aes(x = project, y = value, color = variable), size = 2) +
  coord_flip() + 
  labs(x = '', y = '') + 
  theme(legend.title = element_blank(), legend.position = 'bottom', 
        legend.background = element_blank(), 
        legend.margin = margin(), 
        legend.direction = 'vertical', legend.box.background = element_blank()) +
  scale_color_brewer(type = 'qual', palette = 6)

Fig <- cowplot::plot_grid(cowplot::plot_grid(p1, p2, nrow = 2, labels = c('A', 'B')))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.clinical_factors.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, width = 8.27, height = 11.69, units = 'in')
Legends[[fig_count]] <- "A) Top significant (padj < 0.05) clinical factor-associated LFs per cancer type. B) Harrell’s C-index for progression-free survival prediction accuracy computed using only clinical factors (tumor stage + age + gender) or using clinical factors along with survival-predictive MAUI LFs."


# combine adjusted survival curve plots into a single plot 
plots <- sapply(simplify = F, names(surv.stats), function(x) {   
  p <- surv.stats[[x]][['p']] 
  if(!is.null(p)) { 
    p + theme(axis.text.x = element_text(size = 8), 
              axis.text.y = element_text(size = 8), 
              axis.title.x = element_blank(), 
              axis.title.y = element_blank(), 
              legend.title = element_blank(),
              legend.position = c(0.5, 0.9),
              legend.text = element_text(size = 8), 
              legend.background = element_blank(), 
              legend.direction = 'vertical') 
    }
})
plots <- plots[!sapply(plots, is.null)]
Fig <- cowplot::plot_grid(plotlist = plots, nrow = 6, 
                   labels = sapply(strsplit(names(plots), '\\.'), function(x) x[1]), 
                   label_size = 8)

# print p3 to supplements 
supFig_count <- supFig_count + 1
SuppFigures[[supFig_count]] <- Fig
fig.name <- paste0('SuppFigure', supFig_count, '.adjusted_survival_curves.pdf')
names(SuppFigures)[supFig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name), 
              plot = Fig, units = 'in', width = 8.27, height = 11.69)
SuppLegends[[supFig_count]] <- "Kaplan-Meier survival curves adjusted for clinical factors (tumor stage + age + gender) stratified by the neural activation values of top survival-predictive LFs per cancer."
```

```{r tumor_purity} 

```


```{r msi_stats}
# Predicting MSI status using latent factors
# predict MSI status for pan-gastrointestinal tumors
# read MSI data
dataDir <- settings$GDCdataDir
MSI <- do.call(rbind, lapply(projectDict$`pan-gastrointestinal`, function(pr) {
  f <- file.path(dataDir, paste0(pr, '.MSI.tsv'))
  dt <- data.table::fread(f)[,c(2,4)]
  colnames(dt)[2] <- 'MSI'
  dt$project <- pr
  return(dt)
}))
# remove samples with undertermined MSI status
MSI <- MSI[MSI %in% c('MSI-H', 'MSI-L', 'MSS')]

dt <- do.call(rbind, lapply(names(LFs), function(tool) {
  M <- LFs[[tool]][['pan-gastrointestinal.cnv_gex_meth_mut']]
  y <- MSI[match(rownames(M), bcr_patient_barcode)]$MSI
  M <- M[!is.na(y),]
  y <- y[!is.na(y)]
  
  # find LFs predictive of MSI 
  dt <- get_factor_specific_variables(M, y)
  dt$tool <- tool
  return(dt)
}))

# compare top predictive factors across tools
dt$tool <- toupper(gsub("_factors", "", dt$tool))
p1 <- ggplot(dt[,.SD[which.min(padj)],by = c('ref_cl', 'tool')], 
       aes(x = ref_cl, y = -log10(padj))) + 
  geom_bar(stat = 'identity', aes(fill = tool), position = 'dodge') +
  geom_hline(yintercept = -log10(0.05)) + 
  coord_flip() + 
  theme(legend.title = element_blank(), axis.title.y = element_blank(), 
        plot.title = element_text(hjust = 0.5))

# focus on maui LFs to visualize MSI status-related LFs
M <- LFs$maui_factors[['pan-gastrointestinal.cnv_gex_meth_mut']]
y <- MSI[match(rownames(M), bcr_patient_barcode)]$MSI
M <- M[!is.na(y),]
y <- y[!is.na(y)]
top_vars <- unique(get_top_by_label(dt[tool=='MAUI'][padj < 0.05][order(padj)], 'ref_cl', 10)[['variable']])
df <- plot_tsne(M[,top_vars], y, returnData = T)
top_lf <- dt[order(padj)][ref_cl == 'MSI-H']$variable[1]
df <- merge(df, data.frame(M[,top_lf,drop =F]), by = 'row.names')
p2 <- ggplot(df, aes(x = tSNE1, y = tSNE2)) + 
    geom_point(aes(color = as.factor(group))) + 
    theme(legend.title = element_blank())
p3 <- ggplot(df, aes(x = tSNE1, y = tSNE2)) + 
    geom_point(aes_string(color = top_lf)) + 
    scale_color_gradient(low = 'gray', high = 'red')

p4 <- ggboxplot(df, x = 'group', y = top_lf, color = 'group', 
          add = 'jitter') + theme(legend.position = 'none', 
                                  axis.title.x = element_blank())

# plot a roc curve
rocs <- predict_cluster_labels_glmnet(M, y, returnROC = TRUE)
p5 <- plot_roc_list(rocs)

# top features that contribute to top factors relevant to MSI status prediction
f <- data.table::fread(file.path(inputDir, 'maui_factors', 
                               paste('pan-gastrointestinal', # project 
                                      'cnv_gex_meth_mut', #data type
                                      'maui_factors', # tool
                                      'feature_weights.csv', sep = '.')))
feat.M <- as.matrix(f[,-1])
rownames(feat.M) <- gsub('assay: ', '', f$V1)

# sort features by contribution to LF and plot by data type 
df <- data.frame(feat.M[,top_lf,drop = F])
df$data.type <- sub('^(.+?)\\..+$', '\\1', rownames(df))

# get top 100 features
df <- df[order(abs(df[,top_lf]), decreasing = T),]
freq <- do.call(rbind, lapply(0:29, function(i) {
  s <- (i*100+1)
  e <- (i+1)*100
  x <- data.frame(table(df[s:e,]$data.type))
  x$rank <- stringr::str_wrap(paste0("[",s,",",e,"]"),
                              width = 8)
  x$ind <- i
  return(x)
}))
p6 <- ggplot(freq[freq$ind < 5,], aes(x = reorder(rank, ind), y = Freq)) + 
  geom_bar(aes(fill = Var1), stat='identity') + 
  theme(legend.title = element_blank(), axis.text.x = element_text(angle = 45)) + 
  labs(x = paste0("top features contributing to ",top_lf)) 
  

Fig <- cowplot::plot_grid(p1, p5, p2, p3, p4, p6,
                          nrow = 3, labels = 'AUTO')
fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.MSI.status.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, units = 'in', width = 12, height = 12)
Legends[[fig_count]] <- "Latent factors predictive of MSI status (high: MSI-H, stable: MSI-S, low: MSI-L) in pan-gastrointestinal cancers A) Comparison of top latent factor per MSI status for each tool in terms of adjusted p-values reflecting the differences between MSI subgroups. B) ROC curves for prediction accuracy of MSI status using MAUI latent factors C) tSNE plots of samples generated using top MSI-predictive LFs (5 LF per MSI class) colored by MSI status D) tSNE plots of samples colored by MAUI latent factor LF25, which is most predictive of MSI-H samples. E) Distribution of MAUI latent factor LF25 across MSI subgroups in the pan-gastrointestinal cancer samples. F) Relative abundance of omics feature types among the top 500 features contributing to MAUI latent factor LF25."
```

```{r}
# Analysis of non-small-cell lung cancer types (LUSC vs LUAD)
# reference study: https://www.nature.com/articles/s41598-020-77284-8
M <- LFs$maui_factors$nsclc.cnv_gex_meth_mut
M <- scale(M) 
ct <- gsub("TCGA-", "", surv[match(rownames(M), bcr_patient_barcode)]$project)

# find type-specific LFs
subtype_lfs <- get_factor_specific_variables(M, ct)
top_vars <- get_top_by_label(subtype_lfs[padj < 0.05][order(padj)], 'ref_cl', 1)

# roc curves for predicting lung cancer types
rocs <- predict_cluster_labels_glmnet(M, ct, returnROC = TRUE)
aucs <- sapply(rocs, pROC::auc)
p1 <- pROC::ggroc(rocs, size = 1)
p1$data$name <- paste0(p1$data$name, " (AUC=", round(aucs[p1$data$name], 3),")")
p1 <- p1 + geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed") +
  theme(legend.title = element_blank(), legend.direction = 'vertical')

# tsne plot 
df <- plot_tsne(M, ct, returnData = T)

# top lf for LUSC
top_lf_lusc <- top_vars[ref_cl == 'LUSC']$variable
top_lf_luad <- top_vars[ref_cl == 'LUAD']$variable
df <- cbind(df, 
            M[,top_lf_lusc,drop = F],
            M[,top_lf_luad,drop = F])
p <- ggplot(df, aes(x = tSNE1, y = tSNE2)) 
p2 <- p + geom_point(aes(color = group)) + 
  geom_text_repel(data = get_centroid(df[,1:2], df$group), 
            aes(x,y,label = text.label), size = 5)
p3 <- p + geom_point(aes_string(color = top_lf_lusc)) + 
  scale_color_gradient(low = 'gray', high = 'red') +
  geom_text_repel(data = get_centroid(df[,1:2], df$group), 
            aes(x,y,label = text.label), size = 5)
p4 <- p + geom_point(aes_string(color = top_lf_luad)) + 
  scale_color_gradient(low = 'gray', high = 'red') +
  geom_text_repel(data = get_centroid(df[,1:2], df$group), 
            aes(x,y,label = text.label), size = 5)

# detect subtype specific features that contribute most 
# to top LFs and make a decision tree plot  
## get top 10 markers per top LFs per group
top_vars <- get_top_by_label(subtype_lfs[padj < 0.05][order(padj)], 'ref_cl', 5)
W <- FWs$maui_factors$nsclc.cnv_gex_meth_mut
markers <- unlist(lapply(unique(top_vars$variable), function(x) {
  # get top features per lf and concatenate
  head(sort(abs(W[,x]), decreasing = T), 10)
}))

# import assay data and subset for markers 
A <- data.table::fread(file.path(settings$assay_output$folder, 
                                 'nsclc.cnv_gex_meth_mut.csv'))
A.sub <- A[V1 %in% names(markers)]
#convert to matrix
A.subM <- as.matrix(data.frame(A.sub[,-1],
                               row.names = A.sub$V1, 
                               check.names = F))
labels <- gsub("TCGA-", "", surv[match(colnames(A.subM), bcr_patient_barcode)]$project)

# further filter top features 
top_features <- get_factor_specific_variables(t(A.subM), labels)
# get top 5 per subtype
top_markers <- get_top_by_label(top_features[padj < 0.05][order(padj)], 
                                'ref_cl', topN = 5)
# map ids 
top_markers <- merge(top_markers, map_ids(top_markers$variable, cpg2hgnc, ens2hgnc), by = 'variable')

# use treeheatr and partykit package to compute/visualize decision tree
df <- data.frame(t(round(A.subM[top_markers$variable,], 3)))
colnames(df) <- paste(top_markers$type, top_markers$hgnc, sep = ":")
df$subtype <- as.factor(labels)

set.seed(123)
inTrain <- caret::createDataPartition(df$subtype, p = 0.6)
df.train <- df[inTrain[[1]],]
df.test <- df[-inTrain[[1]],]
p5 <- treeheatr::heat_tree(
  x = partykit::ctree(subtype ~ ., data = df.train),
  data_test = df.test,
  heat_rel_height = 0.4
)

# compute classification accuracy of using top 10 markers in a random forest model
rf_stats <- predict_cluster_labels(t(A.subM[top_markers$variable,]), labels, partition = 0.6)

Fig <-  cowplot::plot_grid(cowplot::plot_grid(p1, p2, p3, p4,
                         labels = 'AUTO', nrow = 2), 
                         p5, nrow = 2, labels = c('', 'E'))

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.luad_vs_lusc.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       Fig, units = 'in', 
       width = 8.27, height = 11.69)

Legends[[fig_count]] <- "Classification of Non-Small-Cell Lung Adenocarcinoma samples using MAUI latent factors.
A) ROC curves with AUC values on testing data (40% of the dataset) using an Elastic Net model with 5-fold cross-validation. B) t-SNE plot of MAUI LFs colored by cancer types. C) t-SNE plot of MAUI LFs colored by 
the top most-predictive latent factor for TCGA-LUSC samples. D) t-SNE plot of MAUI LFs colored by the top 
most predictive latent factor for TCGA-LUAD samples. E) Decision tree visualisation of top LF-associated omics markers detected that can be used to distinguish LUSC and LUAD subtypes."
```

```{r}
# Show subtypes depend on the objective (dependent variable) - they are dynamic, not universal or carved in stone 
# for a given cancer. There is not just one set of subtypes for a given cancer. Subtypes need to be phrased 
# along with the dependent variable used to come up with the subtypes. 
# Patients clustering depend on the objective of stratification
clin_factors <- c('age_at_initial_pathologic_diagnosis', 'gender', 'ajcc_pathologic_tumor_stage')
project <- 'pan-gastrointestinal'
datatype <- 'cnv_gex_meth_mut'
experiment <- paste0(project, '.', datatype)

M <- LFs$maui_factors[[experiment]]
clin <- process_clinical_covariates(rownames(M))
clin <- subset(clin, select = intersect(colnames(clin), clin_factors))

pfi_vars <- get_prognostic_covariates(surv, clin, M, event_col = 'PFI', duration_col = 'PFI.time')
pfi_clust <- get_kmeans_subtypes(M[,unique(pfi_vars$variable)], k_vals = 3:8, min_cluster_size = 0)
pfi_k <- names(which.min(sapply(colnames(pfi_clust), function(x) plot_survival(surv, pfi_clust[,x,drop = F], 'PFI.time', 'PFI', T))))

os_vars <- get_prognostic_covariates(surv, clin, M, event_col = 'OS', duration_col = 'OS.time')
os_clust <- get_kmeans_subtypes(M[,unique(os_vars$variable)], k_vals = 3:8, min_cluster_size = 0)
os_k <- names(which.min(sapply(colnames(os_clust), function(x) plot_survival(surv, os_clust[,x,drop = F], 
                                                                             'OS.time', 'OS', T))))

# combine with known pan-gi subtype annotation
df <- merge(pfi_clust[,pfi_k,drop = F], os_clust[,os_k,drop = F], by = 'row.names')
df$subtype <- tcga_subtypes[match(df$Row.names, bcr_patient_barcode)]$Subtype_Selected
df[is.na(df$subtype),]$subtype <- 'Unavailable'
df$msi <- MSI[match(df$Row.names, bcr_patient_barcode)]$MSI
df[is.na(df$msi),]$msi <- 'Unavailable'
rownames(df) <- df$Row.names
df$Row.names <- NULL
colnames(df) <- c('Overall Survival', 'Progression Free Survival', 'Molecular Subtype', 'MSI Status')
df <- data.frame(apply(df, 2, as.factor), check.names = F)
df <- df[order(df[,1]),]
m <- apply(df, 2, function(x) as.numeric(as.factor(x)))
rownames(m) <- rownames(df)

colors <- structure(1:7, names = c("1", "2", "3", "4", "5", "6", "7"))
p1 <- Heatmap(t(m), name = "cluster", col = colors, cluster_rows = F, cluster_columns = F,
              show_column_names = F, row_names_side = 'left',
              column_title = 'Pan-gastrointestinal Cancer Samples\n(ordered by Overall Survival Clusters)')
p1 <- grid::grid.grabExpr(ComplexHeatmap::draw(p1))
# compute pairwise AMI 
ami <- sapply(colnames(df), function(x) {
  sapply(colnames(df), function(y) {
    df <- df[!is.na(df[,x]) & !is.na(df[,y]),]
    aricode::AMI(df[,x], df[,y])
  })
})

p2 <- ggcorrplot::ggcorrplot(ami, legend.title = 'AMI', lab = T, type = 'lower', outline.color = 'white') +
  scale_fill_gradient(limits = c(0,1), low = 'white', high = 'red') + 
  guides(fill=guide_legend(title='AMI'))

Fig <- cowplot::plot_grid(p1, p2, labels = 'AUTO', nrow = 2)
supFig_count <- supFig_count + 1
SuppFigures[[supFig_count]] <- Fig
fig.name <- paste0('SuppFigure', supFig_count, '.subtype_dependency.pdf')
names(SuppFigures)[supFig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name), 
              plot = Fig, units = 'in', width = 18, height = 12)
SuppLegends[[supFig_count]] <- "Demonstration of how cancer subtypes are context/objective dependent.
A) Heatmap of patient cluster memberships based on different objectives: optimum stratification based on overall survival or progression free survival, molecular homogeneity (TCGA pan-GI subtypes), or micro-satellite instability (MSI) status. Columns are ordered first by membership in the optimum Overall Survival cluster membership. B) Pairwise Adjusted Mutual Information (AMI) of cluster labels obtained via different patient stratification methods. The AMI value ranges from 0 to 1 and the higher the value, the more overlap between patient partitions."
```


```{r immunotherapy_response}
# immunotherapy response prediction analysis: 
# TODO: pass paths via args
settings_imtrp <- yaml::read_yaml('/data/local/buyar/arcas/pancancer_multiomics_manuscript/results/immunotherapy_response/Mariathasan_et_al/settings.yaml')
pathways <- readRDS('/data/local/buyar/arcas/subtyping_paper/data/GeneSets/msigdb.pathways.RDS')  

LFs_imtrp <- import_LFs(c('maui_factors', 'mofa_factors', 'pca_factors'), settings_imtrp$pipeline_output)
FWs_imtrp <- import_feature_weights(c('maui_factors'), settings_imtrp$pipeline_output)
colData <- data.table::fread(settings_imtrp$clin)
colnames(colData)[1] <- 'bcr_patient_barcode'

dt <- do.call(rbind, lapply(names(LFs_imtrp), function(tool) {
  M <- LFs_imtrp[[tool]]$mariathasan.gex
  # find LFs predictive of response to therapy 
  dt <- get_factor_specific_variables(M, colData$binaryResponse)[order(padj)]
  #dt <- compute_anova(M, colData$binaryResponse)
  dt$tool <- tool
  return(dt)
}))

dt[,.SD[which.min(padj)],by = c('tool', 'ref_cl')]
dt$tool <- toupper(gsub("_factors", "", dt$tool))
dt$ref_cl <- ifelse(dt$ref_cl == 'CR/PR', 'Responders', 'Non-responders')

p1 <- ggplot(dt[,.SD[which.min(padj)],by = c('tool', 'ref_cl')], 
       aes(x = ref_cl, y = -log10(padj))) + 
  geom_bar(stat = 'identity', aes(fill = tool), position = 'dodge') +
  geom_hline(yintercept = -log10(0.05)) + 
  coord_flip() + 
  theme(legend.title = element_blank(), axis.title.y = element_blank(), 
        plot.title = element_text(hjust = 0.5))

# heatmap of top vars 
# plot maui factors for responders/non-responders
M <- LFs_imtrp$maui_factors$mariathasan.gex
top_vars <- unique(dt[tool == 'MAUI'][padj < 0.01]$variable)
m <- M[,top_vars]
f <- ifelse(colData$binaryResponse == 'CR/PR', 'Responders', 'Non-responders')
m <- m[!is.na(f),]
f <- f[!is.na(f)]
p2 <- pheatmap::pheatmap(get_basis_matrix(m[,top_vars], f), silent = T)

# survival stratification using the top LF 
require(survminer)
require(survival)
top_lf <- dt[order(padj)][ref_cl == 'Responders'][1,]$variable
cp <- find_survival_cutpoint(m[,top_lf,drop = F], colData, event_col = 'censOS', duration_col = 'os')
p3 <- plot_survival(surv = colData, 
                    partition.df = data.frame('group' = ifelse(m[,top_lf] > cp, 
                                              paste0(top_lf, ">", round(cp, 1)),
                                              paste0(top_lf, "<=", round(cp, 1))), 
                                              row.names = rownames(m)), 
                    duration_col = 'os', event_col = 'censOS') 

# top go terms for top features of top LF 
W <- FWs_imtrp$maui_factors$mariathasan.gex
feats <- data.table(W[,top_lf,drop=F], keep.rownames = T)[order(abs(get(top_lf)), decreasing = T)][1:100]
# top pathways for top lf
top_terms <- compute_geneset_enrichment(feats$rn, pathways)[order(pval)][padj < 0.05][1:5]
top_terms$term_wr <- stringr::str_wrap(gsub("_", " ", top_terms$term), width = 24)
p4 <- ggplot(top_terms, aes(x = reorder(term_wr, -pval), y = -log10(padj))) + 
  geom_bar(stat = 'identity') + 
  coord_flip() + labs(x = '') 
colnames(feats)[2] <- 'top_lf'
p5 <- ggplot(feats[1:10,], aes(x = reorder(rn, abs(top_lf)), y = abs(top_lf))) + 
  geom_bar(stat = 'identity') + coord_flip() + labs(x = '', y = 'Feature Importance (absolute)')

# correlation of top LF with tumor mutation burden
# get samples with both response and tmb annotation
dt <- do.call(rbind, lapply(names(LFs_imtrp), function(tool) {
  M <- LFs_imtrp[[tool]]$mariathasan.gex
  dt <- data.table(cor(M, colData$`Neoantigen burden per MB`, use = 'complete.obs'),
                   keep.rownames = T)
  dt$tool <- tool
  return(dt)
}))
dt <- dt[,.SD[which.max(abs(V1))], by = c('tool')]
dt$tool <- toupper(gsub("_factors", "", dt$tool))
p6 <- ggplot(dt, aes(x = tool, y = abs(V1))) + 
  geom_bar(stat = 'identity', aes(fill = tool), position = 'dodge') +
  coord_flip() + 
  labs(y = 'Correlation with Tumor Mutation Burden') + 
  theme(legend.title = element_blank(), axis.title.y = element_blank(), 
        plot.title = element_text(hjust = 0.5)) 
# immune phenotypes 
dt <- do.call(rbind, lapply(names(LFs_imtrp), function(tool) {
  M <- LFs_imtrp[[tool]]$mariathasan.gex
  # find LFs predictive of immune phenotypes 
  dt <- get_factor_specific_variables(M, colData$`Immune phenotype`)[order(padj)]
  dt$tool <- tool
  return(dt)
}))

dt[,.SD[which.min(padj)],by = c('ref_cl', 'tool')]
dt$tool <- toupper(gsub("_factors", "", dt$tool))
p7 <- ggplot(dt[,.SD[which.min(padj)],by = c('ref_cl', 'tool')], 
             aes(x = ref_cl, y = -log10(padj))) + 
  geom_bar(stat = 'identity', aes(fill = tool), position = 'dodge') +
  geom_hline(yintercept = -log10(0.05)) + 
  labs(x = 'Tumor Immune Phenotypes') + 
  coord_flip() + 
  theme(legend.title = element_blank(), axis.title.y = element_blank(), 
        plot.title = element_text(hjust = 0.5)) 

Fig <- cowplot::plot_grid(
  cowplot::plot_grid(p1, p6, p7, nrow = 1, labels = 'AUTO'),
  cowplot::plot_grid(p2$gtable, p3$plot, p4, p5, nrow = 2, labels = c('D', 'E', 'F', 'G')),
  nrow = 2, 
  rel_heights = c(1,2)
  ) 
fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.immunotherapy_response.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(filename = file.path(FigureFolder, fig.name), 
       plot = Fig, units = 'in', 
       width = 12, height = 14)
Legends[[fig_count]] <- "Predicting responders to anti-PD-L1 treatment in a cohort of Metastatic Urothelial
Cancers (N=348) using MAUI. A) Comparison of top latent factors predictive of complete/partial response (CR/PR) to the anti-PD-L1. B) Comparison of top latent factors with respect to their correlation with tumor mutation burden status of the samples in the cohort C) Comparison of top latent factors predictive of immune phenotypes (inflamed/excluded/desert). D) Top MAUI LFs predictive of response to anti-PD-L1 response groups. E) Survival stratification of the cohort based activation score of LF44 (high = LF44 > 1.4, low = LF44 < 1.4). F) Top pathways enriched among top 100 genes that contribute to the top latent factor (LF44). G) Top 10 genes contributing to LF44"
```


```{r tmz_gbm}
# TMZ resistance in GBM anaysis by Jona.
# Here I import figure data to have consistent figure styles
folder <- '/data/local/buyar/arcas/pancancer_multiomics_manuscript/results/tmz_gbm_jona'

# cross-validation results predicting TMZ resistance using 
# maui LFs and other known markers 
aucs <- data.table::fread(file.path(folder, 'aucs.csv'))
aucs$group <- ifelse(grepl('LF', aucs$method), 'maui', 'no-maui')
aucs$method <- gsub("LF[Ss]", "MAUI LFs", aucs$method)
colnames(aucs)[2] <- c('AUC')
Fig <- ggpubr::ggbarplot(aucs, x = 'method', y = 'AUC', add = 'mean_se',
                  fill = 'group') +
  theme(axis.title.x = element_blank(), legend.position = 'none', 
        ) + 
  scale_fill_brewer(type = 'qual', palette = 3)

fig_count <- fig_count + 1
Figures[[fig_count]] <- Fig
fig.name <- paste0('Figure', fig_count, '.tmz_gbm.pdf')
names(Figures)[fig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name),
              plot = Fig, units = 'in', width = 10, height = 6)
Legends[[fig_count]] <- "Classification accuracy quantified as the Area under the ROC (AUC) when predicting TMZ resistance in GBM patients using MAUI LFs alone or in combination with the MGMT expression or promoter methylation values."

# supplementary figure
topGenes <- data.table::fread(file.path(folder, 'top100_genes.csv'))
colnames(topGenes)[4] <- 'literature'
topGenes$label <- 'Other'
topGenes[MMR == TRUE]$label <- 'MMR Pathway'
topGenes[literature == TRUE]$label <- 'Literature Support'

supFig <- ggpubr::ggbarplot(topGenes, x = 'V1', y = 'Gene score', 
                  fill = 'label') +
  theme(axis.title.y = element_blank(), legend.title = element_blank(),
        axis.text.y = element_text(size = 8)) +
  coord_flip()

supFig_count <- supFig_count + 1
SuppFigures[[supFig_count]] <- supFig
fig.name <- paste0('SuppFigure', supFig_count, '.tmz_gbm.supp.pdf')
names(SuppFigures)[supFig_count] <- fig.name
ggsave(file.path(FigureFolder, fig.name), 
              plot = supFig, units = 'in', width = 8.27, height = 11.69)
SuppLegends[[supFig_count]] <- "Top 100 genes sorted by importance in predicting TMZ resistance in GBM patients."
```

```{r print_figures, results='asis', include=TRUE}
base_url <- 'https://bimsbstatic.mdc-berlin.de'
for(i in 1:length(Figures)) {
  fig.url <- gsub("/data/bimsbstatic/public", base_url, file.path(FigureFolder, names(Figures)[i]))
  cat("# Figure",i,"[high-res image](",fig.url,")\n\n")
  print(Figures[[i]])
  cat("\n\n Figure",i,":",Legends[[i]],"\n\n")
}

for(i in 1:length(SuppFigures)) {
  fig.url <- gsub("/data/bimsbstatic/public", base_url, file.path(FigureFolder, names(SuppFigures)[i]))
  cat("# Supplementary Figure",i,"[high-res image](",fig.url,")\n\n")
  print(SuppFigures[[i]])
  cat("\n\n Supplementary Figure",i,":",SuppLegends[[i]],"\n\n")
}
```

`r date()`
